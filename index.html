<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="VocalForge Pro - Tools Voice Over AI Gratis dengan 50+ Gaya & Konteks.">
    <title>VocalForge Pro - Lintas Nusa AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/idb@7.1.1/build/index-min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; background-image: radial-gradient(at 50% 0%, #1e293b 0%, #0f172a 70%); color: #f1f5f9; -webkit-tap-highlight-color: transparent; display: flex; flex-direction: column; min-height: 100vh; }
        .glass-panel { background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); }
        ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        /* Form Elements High Contrast & Clickable */
        select, input, textarea { background-color: rgba(15, 23, 42, 0.9); border: 1px solid #475569; color: white; transition: all 0.2s ease; z-index: 10; position: relative; }
        select:focus, input:focus, textarea:focus { border-color: #38bdf8; background-color: #0f172a; outline: none; box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.3); }
        /* Fix dropdown visibility on mobile */
        select option { background-color: #0f172a; color: white; padding: 10px; } 

        .tab-btn { position: relative; transition: all 0.3s; }
        .tab-btn.active { color: #38bdf8; background: rgba(56, 189, 248, 0.1); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 20%; width: 60%; height: 3px; background: #38bdf8; border-radius: 3px 3px 0 0; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #38bdf8; cursor: pointer; margin-top: -7px; border: 2px solid #fff; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #334155; border-radius: 2px; }
        
        .chat-row { display: flex; margin-bottom: 12px; align-items: flex-end; width: 100%; }
        .chat-row.speaker-a { justify-content: flex-start; } .chat-row.speaker-b { justify-content: flex-end; }
        .chat-bubble { max-width: 85%; padding: 10px 14px; border-radius: 16px; font-size: 0.9rem; line-height: 1.4; position: relative; }
        .chat-row.speaker-a .chat-bubble { background: #1e293b; border: 1px solid #334155; color: #e2e8f0; border-bottom-left-radius: 4px; }
        .chat-row.speaker-b .chat-bubble { background: linear-gradient(135deg, #0284c7, #0ea5e9); border: none; color: white; border-bottom-right-radius: 4px; }
        
        .loader { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.4s ease-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .bar { width: 6px; height: 12px; background: #38bdf8; border-radius: 4px; transition: height 0.1s; }
        .animating .bar { animation: bounce 0.6s infinite ease-in-out alternate; }
        @keyframes bounce { 0% { height: 12px; opacity: 0.5; } 100% { height: 32px; opacity: 1; background: #bae6fd; } }
        
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .modal.show { display: flex; animation: fadeIn 0.3s ease; }
        
        /* Static Pages */
        .prose-custom h2 { font-size: 1.5rem; font-weight: 700; color: #38bdf8; margin-bottom: 0.5rem; border-bottom: 1px solid #334155; padding-bottom: 0.5rem; }
        .prose-custom h3 { font-size: 1.1rem; font-weight: 600; color: #e2e8f0; margin-top: 1rem; margin-bottom: 0.5rem; }
        .prose-custom p { margin-bottom: 0.5rem; color: #cbd5e1; font-size: 0.9rem; }
        .prose-custom ul { list-style: disc; padding-left: 1.5rem; color: #cbd5e1; font-size: 0.9rem; }
    </style>
</head>
<body class="min-h-screen flex flex-col pb-safe">

    <!-- Navbar -->
    <nav class="border-b border-slate-700/50 bg-slate-900/80 sticky top-0 z-50 backdrop-blur-lg">
        <div class="max-w-4xl mx-auto px-4 sm:px-6">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3 cursor-pointer" onclick="navigateTo('home')">
                    <img src="1000063032.png" onerror="this.onerror=null; this.src='https://cdn-icons-png.flaticon.com/512/4712/4712009.png';" alt="Logo" class="h-10 w-10 object-cover rounded-full bg-slate-800 border-2 border-slate-700">
                    <div>
                        <span class="font-bold text-lg tracking-tight text-white leading-none">VocalForge <span class="text-sky-400">Pro</span></span>
                        <span class="text-[10px] font-medium text-slate-400 tracking-wide uppercase">Lintas Nusa AI</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- BANNER HIJAU AMAN -->
    <div class="bg-emerald-900/30 border-b border-emerald-500/20 py-2 px-4">
        <div class="max-w-4xl mx-auto flex flex-col sm:flex-row items-center justify-center gap-2 text-center">
            <p class="text-[10px] text-emerald-200 font-medium">‚úÖ Tools ini GRATIS. Dilarang memperjualbelikan. Lapor ke:</p>
            <a href="https://www.threads.net/@lintasnusa.ai" target="_blank" class="flex items-center gap-1.5 bg-emerald-800/40 hover:bg-emerald-700/50 text-white text-[10px] font-bold px-3 py-1 rounded-full border border-emerald-500/30 transition-all"><i class="fa-brands fa-threads"></i> @lintasnusa.ai</a>
        </div>
    </div>

    <div id="content-wrapper" class="flex-grow flex flex-col">
        <main id="main-app" class="flex-grow p-4 md:p-6 max-w-4xl mx-auto w-full space-y-6">

            <!-- API Config -->
            <div id="ai-config" class="glass-panel p-5 relative overflow-hidden fade-in">
                <div class="absolute -top-12 -right-12 w-32 h-32 bg-sky-500/10 rounded-full blur-2xl pointer-events-none"></div>
                <label class="block text-xs font-bold text-sky-100 mb-3 flex items-center gap-2"><span class="bg-sky-500/20 text-sky-400 p-1.5 rounded-md"><i class="fa-brands fa-google"></i></span> CONFIG API (ANTI-LIMIT)</label>
                <div class="flex gap-0 rounded-xl border border-slate-600 focus-within:border-sky-500 focus-within:ring-1 focus-within:ring-sky-500 transition-all bg-slate-900/60 overflow-hidden shadow-inner">
                    <div class="pl-3 pr-2 flex items-center justify-center bg-transparent"><i class="fa-solid fa-key text-slate-500 text-xs"></i></div>
                    <input type="password" id="api-key" placeholder="Paste Gemini API Key here..." class="flex-grow bg-transparent border-none text-white text-sm px-2 py-3 focus:ring-0 placeholder-slate-500 outline-none w-full font-mono tracking-wide">
                    <div class="w-px bg-slate-700 my-2"></div>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="flex items-center px-4 bg-slate-800/50 hover:bg-slate-700 text-sky-400 text-xs font-bold transition-colors whitespace-nowrap">Get Key <i class="fa-solid fa-arrow-up-right-from-square ml-1.5 text-[10px]"></i></a>
                </div>
                <p class="text-[9px] text-emerald-500/80 mt-2 flex items-center gap-1.5 ml-1"><i class="fa-solid fa-shield-halved"></i> Key aman & tersimpan lokal. Sistem Anti-Limit Aktif.</p>
            </div>

            <!-- Mode Tabs -->
            <div class="bg-slate-800/40 p-1 rounded-xl flex border border-slate-700/50">
                <button onclick="switchTab('monologue')" id="tab-monologue" class="tab-btn active flex-1 py-3 text-sm font-semibold rounded-lg flex items-center justify-center gap-2 text-sky-400 bg-sky-500/10"><i class="fa-solid fa-microphone-lines"></i> Monolog</button>
                <button onclick="switchTab('dialogue')" id="tab-dialogue" class="tab-btn flex-1 py-3 text-sm font-semibold rounded-lg flex items-center justify-center gap-2 text-slate-400 hover:text-slate-300"><i class="fa-solid fa-comments"></i> Dialog</button>
            </div>

            <!-- === MONOLOG === -->
            <div id="monologue-section" class="space-y-5 fade-in">
                <div class="glass-panel p-4 flex justify-between items-center pb-0 border-b-0">
                    <label class="text-xs font-bold text-slate-300 uppercase tracking-wide">Pilihan Mode</label>
                    <div class="flex bg-slate-900 rounded-lg p-1 border border-slate-700">
                        <button onclick="setEngine('standard')" id="btn-std" class="px-3 py-1.5 rounded-md text-[10px] font-bold text-slate-400 hover:text-white transition-all">HP (Offline)</button>
                        <button onclick="setEngine('ai')" id="btn-ai" class="px-3 py-1.5 rounded-md text-[10px] font-bold bg-sky-600 text-white shadow-md transition-all">Gemini (Pro)</button>
                    </div>
                </div>

                <div class="glass-panel p-5 space-y-3">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-bold text-slate-400 uppercase">Naskah</label>
                        <div class="flex gap-2">
                            <button onclick="openAiWriter('monologue')" class="text-[10px] font-bold text-purple-300 bg-purple-500/10 px-3 py-1 rounded-lg border border-purple-500/30 hover:bg-purple-500 hover:text-white transition-all flex items-center gap-1"><i class="fa-solid fa-wand-magic-sparkles"></i> AI Writer</button>
                            <button onclick="clearText()" class="text-[10px] text-red-400 hover:text-red-300 transition-colors" title="Hapus"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="relative">
                        <textarea id="text-input" class="w-full h-32 bg-slate-900/50 text-slate-200 border border-slate-600 rounded-xl p-4 text-sm focus:ring-2 focus:ring-sky-500/50 outline-none resize-none placeholder-slate-600 leading-relaxed" placeholder="Ketik naskah..."></textarea>
                        <div class="absolute bottom-3 right-3 text-[10px] text-slate-500 font-mono"><span id="charCount">0 chars</span></div>
                    </div>
                </div>

                <div class="glass-panel p-5 space-y-5">
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">Voice Actor</label>
                        <div class="flex gap-2">
                            <div class="relative flex-grow">
                                <select id="voice-select" class="w-full h-11 pl-3 pr-8 rounded-xl bg-slate-800 border border-slate-600 text-white text-sm appearance-none focus:border-sky-500 cursor-pointer">
                                    <!-- HARDCODED DEFAULT VOICES TO PREVENT EMPTY LIST -->
                                    <option value="Kore">‚ú® Kore (Calm/Standard)</option>
                                    <option value="Fenrir">‚ú® Fenrir (Deep/Berat)</option>
                                    <option value="Puck">‚ú® Puck (Energetic/Ceria)</option>
                                    <option value="Zephyr">‚ú® Zephyr (Professional/News)</option>
                                    <option value="Aoede">‚ú® Aoede (Elegant/Anggun)</option>
                                    <option value="Charon">‚ú® Charon (Gravelly/Serak)</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-400"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                            </div>
                            <button id="refresh-voices-btn" onclick="forceReloadVoices()" class="hidden w-11 h-11 bg-slate-800 hover:bg-slate-700 rounded-xl border border-slate-600 text-sky-400 flex-shrink-0 flex items-center justify-center transition-all" title="Refresh"><i class="fa-solid fa-rotate"></i></button>
                        </div>
                    </div>

                    <div id="ai-controls" class="space-y-4 pt-2">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1.5">
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Bahasa</label>
                                <select id="ai-language-select" class="w-full h-10 pl-3 pr-8 rounded-lg bg-slate-800 border border-slate-600 text-white text-xs appearance-none">
                                    <option value="Indonesian">üáÆüá© Indonesia</option><option value="Javanese">üáÆüá© Jawa</option><option value="Sundanese">üáÆüá© Sunda</option>
                                    <option value="English">üá∫üá∏ English</option><option value="Japanese">üáØüáµ Japanese</option><option value="Korean">üá∞üá∑ Korean</option><option value="Chinese">üá®üá≥ Chinese</option>
                                </select>
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Modifikasi</label>
                                <select id="voice-mod-select" class="w-full h-10 pl-3 pr-8 rounded-lg bg-slate-800 border border-slate-600 text-white text-xs appearance-none">
                                    <option value="">Normal</option><option value="deep">üîâ Berat</option><option value="high">üîä Tinggi</option><option value="slow">üê¢ Lambat</option><option value="fast">üêá Cepat</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="space-y-1.5">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Karakter & Emosi</label>
                            <div class="relative">
                                <select id="style-select" class="w-full h-11 pl-3 pr-8 rounded-xl bg-slate-800 border border-slate-600 text-white text-sm appearance-none cursor-pointer"></select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-400"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                            </div>
                        </div>

                        <div id="context-container" class="space-y-1.5">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Konteks</label>
                            <div class="relative">
                                <select id="context-select" class="w-full h-11 pl-3 pr-8 rounded-xl bg-slate-800 border border-slate-600 text-white text-sm appearance-none cursor-pointer"></select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-400"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                            </div>
                        </div>

                        <div id="custom-prompt-container" class="hidden">
                            <input type="text" id="custom-prompt-input" placeholder="e.g. Speak like a wise old man..." class="w-full h-10 rounded-lg bg-slate-900 border border-purple-500/50 text-white text-sm px-3 outline-none focus:border-purple-500">
                        </div>
                        
                        <div class="text-right"><button onclick="toggleDebug()" class="text-[10px] text-slate-500 hover:text-white underline">Lihat Prompt</button></div>
                        <div id="debug-container" class="hidden mt-2 p-3 bg-black/40 rounded-lg border border-slate-700"><textarea id="debug-prompt" readonly class="w-full h-16 bg-transparent text-[10px] text-green-400 font-mono resize-none outline-none"></textarea></div>
                    </div>

                    <div id="standard-controls" class="hidden grid grid-cols-2 gap-4 pt-2">
                        <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                            <div class="flex justify-between mb-2"><label class="text-[10px] font-bold text-slate-400 uppercase">Kecepatan</label><span id="rate-val" class="text-[10px] text-sky-400 font-mono">1.0</span></div>
                            <input type="range" id="rate" min="0.5" max="2" value="1" step="0.1" class="range-slider" oninput="document.getElementById('rate-val').innerText = this.value">
                        </div>
                        <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                            <div class="flex justify-between mb-2"><label class="text-[10px] font-bold text-slate-400 uppercase">Nada</label><span id="pitch-val" class="text-[10px] text-sky-400 font-mono">1.0</span></div>
                            <input type="range" id="pitch" min="0" max="2" value="1" step="0.1" class="range-slider" oninput="document.getElementById('pitch-val').innerText = this.value">
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button id="speak-btn" class="flex-grow bg-gradient-to-r from-sky-600 to-blue-600 hover:from-sky-500 hover:to-blue-500 text-white font-bold py-3.5 px-6 rounded-xl shadow-lg shadow-sky-900/40 transition-all active:scale-[0.98] flex justify-center items-center gap-2 group"><i class="fa-solid fa-play group-hover:scale-110 transition-transform"></i> Generate & Play</button>
                        <button onclick="downloadLastAudio()" id="btn-download-mono" class="w-14 bg-emerald-700/80 text-emerald-100 rounded-xl hover:bg-emerald-600 border border-emerald-600/30 transition-all flex items-center justify-center hidden" title="Download Audio"><i class="fa-solid fa-download text-lg"></i></button>
                    </div>
                </div>
                
                <div id="history-container" class="hidden mt-4">
                    <div class="flex justify-between items-center mb-3"><h3 class="text-xs font-bold text-slate-400 uppercase flex items-center gap-2 ml-1"><i class="fa-solid fa-clock-rotate-left"></i> Riwayat (24 Jam)</h3><button onclick="clearHistory()" class="text-[10px] text-red-400 hover:text-red-300">Hapus Semua</button></div>
                    <div id="history-list" class="space-y-2"></div>
                </div>
            </div>

            <!-- === DIALOG === -->
            <div id="dialogue-section" class="hidden space-y-5 fade-in">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-800/40 p-3 rounded-xl border border-slate-700/50 border-l-4 border-l-slate-500">
                        <div class="text-xs font-bold text-slate-300 mb-2 flex items-center gap-2"><i class="fa-solid fa-user-circle"></i> Speaker A</div>
                        <select id="voice-a" class="w-full bg-slate-900/80 border-0 text-xs text-white p-2 rounded-lg mb-1.5 focus:ring-1 focus:ring-slate-500"></select>
                        <select id="style-a" class="w-full bg-slate-900/80 border-0 text-xs text-slate-300 p-2 rounded-lg focus:ring-1 focus:ring-slate-500"></select>
                        <div id="custom-a-container" class="hidden mt-1"><input type="text" id="custom-prompt-a" placeholder="Instruksi Custom A..." class="w-full bg-slate-900 text-white text-[10px] p-1.5 rounded border border-purple-500/30 focus:border-purple-500 outline-none"></div>
                    </div>
                    <div class="bg-slate-800/40 p-3 rounded-xl border border-slate-700/50 border-r-4 border-r-sky-500 text-right">
                        <div class="text-xs font-bold text-sky-400 mb-2 flex items-center justify-end gap-2">Speaker B <i class="fa-solid fa-user-circle"></i></div>
                        <select id="voice-b" class="w-full bg-slate-900/80 border-0 text-xs text-white p-2 rounded-lg mb-1.5 focus:ring-1 focus:ring-sky-500" dir="rtl"></select>
                        <select id="style-b" class="w-full bg-slate-900/80 border-0 text-xs text-slate-300 p-2 rounded-lg focus:ring-1 focus:ring-sky-500" dir="rtl"></select>
                        <div id="custom-b-container" class="hidden mt-1"><input type="text" id="custom-prompt-b" placeholder="Instruksi Custom B..." class="w-full bg-slate-900 text-white text-[10px] p-1.5 rounded border border-purple-500/30 focus:border-purple-500 outline-none text-right"></div>
                    </div>
                </div>
                <div class="glass-panel p-0 overflow-hidden flex flex-col min-h-[400px] relative">
                    <div id="chat-container" class="flex-grow p-4 space-y-3 overflow-y-auto max-h-[400px] scroll-smooth bg-slate-900/30">
                        <div class="flex flex-col items-center justify-center h-full text-slate-500 opacity-60 mt-8"><i class="fa-regular fa-comments text-3xl mb-2"></i><span class="text-xs">Belum ada percakapan</span></div>
                    </div>
                    <div class="border-t border-slate-700 p-4 bg-slate-800/90 backdrop-blur-md z-10">
                        <div class="flex justify-end mb-2"><button onclick="openAiWriter('dialogue')" class="text-[9px] font-bold bg-purple-600/20 text-purple-400 border border-purple-500/30 px-2 py-0.5 rounded hover:bg-purple-600 hover:text-white transition-all flex items-center gap-1"><i class="fa-solid fa-wand-magic-sparkles"></i> AI Script Generator</button></div>
                        <form onsubmit="event.preventDefault(); addLine();" class="flex items-center gap-2 mb-2">
                            <div class="relative shrink-0">
                                <select id="speaker-select" class="h-11 pl-3 pr-8 bg-slate-700 text-white text-xs font-bold rounded-xl border border-slate-600 focus:border-sky-500 outline-none appearance-none transition-all cursor-pointer hover:bg-slate-600">
                                    <option value="A">Spk A</option><option value="B">Spk B</option>
                                </select>
                                <div class="absolute inset-y-0 right-2.5 flex items-center pointer-events-none text-slate-400"><i class="fa-solid fa-caret-down text-[10px]"></i></div>
                            </div>
                            <div class="flex-grow relative h-11">
                                <input type="text" id="line-input" enterkeyhint="send" class="w-full h-full bg-slate-900 text-white text-sm rounded-xl pl-4 pr-11 border border-slate-600 focus:border-sky-500 focus:ring-1 focus:ring-sky-500 outline-none transition-all placeholder-slate-500 shadow-inner" placeholder="Ketik dialog..." autocomplete="off">
                                <button type="submit" class="absolute right-1.5 top-1.5 bottom-1.5 w-8 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg flex items-center justify-center shadow-sm transition-all active:scale-95" title="Kirim"><i class="fa-solid fa-paper-plane text-xs"></i></button>
                            </div>
                        </form>
                        <div class="flex justify-between items-center px-1 mb-3"><p class="text-[9px] text-slate-500 flex items-center gap-1.5 opacity-80 bg-slate-900/50 px-2 py-0.5 rounded border border-slate-700/50"><span class="font-bold text-sky-400">Enter ‚Üµ</span> untuk kirim</p></div>
                        <div class="flex gap-2 pt-3 border-t border-slate-700/50">
                            <button onclick="playDialogue()" id="btn-dialog-play" class="flex-grow bg-gradient-to-r from-sky-600 to-blue-600 hover:from-sky-500 hover:to-blue-500 text-white font-bold py-2.5 rounded-lg shadow-md transition-all active:scale-[0.98] text-xs flex justify-center items-center gap-2"><i class="fa-solid fa-film"></i> Generate Scene</button>
                            <button onclick="exportDialogue()" id="btn-dialog-download" class="w-12 bg-emerald-700/80 text-emerald-100 rounded-xl hover:bg-emerald-600 border border-emerald-600/30 transition-all flex items-center justify-center hidden" title="Download WAV"><i class="fa-solid fa-download"></i></button>
                            <button onclick="clearChat()" class="w-12 bg-slate-700/50 text-slate-400 rounded-xl hover:bg-red-900/40 hover:text-red-400 border border-slate-600/50 hover:border-red-500/30 transition-all flex items-center justify-center" title="Hapus Chat"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-center h-10 gap-1.5 items-end opacity-50 transition-opacity duration-300 mt-2" id="visualizer"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
            <audio id="audio-player" class="w-full hidden" controls></audio>
            <div id="status-bar" class="fixed bottom-0 left-0 w-full bg-slate-900/90 border-t border-slate-700 p-2 text-center text-[10px] text-sky-400 font-mono hidden backdrop-blur-sm z-50">Ready</div>
        </main>

        <div id="static-pages" class="hidden flex-grow p-4 md:p-6 max-w-4xl mx-auto w-full space-y-6">
            <div id="privacy-content" class="static-content hidden glass-panel p-6">
                <h2 class="text-2xl font-bold text-sky-400 mb-4">Kebijakan Privasi</h2>
                <div class="prose-custom text-sm text-slate-300">
                    <p>Terakhir diperbarui: Februari 2026</p>
                    <h3>1. Data API Key</h3><p>Kami tidak menyimpan API Key Anda di server kami. Kunci API disimpan secara lokal di browser perangkat Anda menggunakan <code>localStorage</code>.</p>
                    <h3>2. Data Suara</h3><p>Naskah yang Anda masukkan dikirim langsung ke Google Gemini API untuk diproses. Kami tidak menyimpan naskah atau audio Anda.</p>
                    <h3>3. Iklan (AdSense)</h3><p>Kami menggunakan Google AdSense untuk menayangkan iklan. Layanan ini mungkin menggunakan cookie untuk menayangkan iklan yang relevan.</p>
                </div>
                <button onclick="navigateTo('home')" class="mt-6 px-4 py-2 bg-slate-700 rounded-lg text-white text-xs hover:bg-slate-600">Kembali</button>
            </div>
            <div id="about-content" class="static-content hidden glass-panel p-6">
                <h2 class="text-2xl font-bold text-sky-400 mb-4">Tentang Kami</h2>
                <div class="prose-custom text-sm text-slate-300"><p><b>VocalForge Pro</b> dikembangkan oleh <b>Lintas Nusa AI</b>.</p></div>
                <button onclick="navigateTo('home')" class="mt-6 px-4 py-2 bg-slate-700 rounded-lg text-white text-xs hover:bg-slate-600">Kembali</button>
            </div>
            <div id="contact-content" class="static-content hidden glass-panel p-6">
                <h2 class="text-2xl font-bold text-sky-400 mb-4">Hubungi Kami</h2>
                <div class="prose-custom text-sm text-slate-300"><p>Email: support@lintasnusa.ai</p></div>
                <button onclick="navigateTo('home')" class="mt-6 px-4 py-2 bg-slate-700 rounded-lg text-white text-xs hover:bg-slate-600">Kembali</button>
            </div>
        </div>

        <div class="glass-panel p-4 border-t-4 border-slate-600 space-y-4">
             <div class="bg-slate-900/30 p-3 rounded-lg border border-slate-700/30">
                 <p class="text-[9px] text-slate-400 text-justify leading-relaxed"><b>VocalForge Pro</b> adalah tools voice over AI gratis untuk kebutuhan konten, promosi, dan edukasi dengan 50+ karakter suara natural.</p>
            </div>
            <div class="grid grid-cols-5 gap-4">
                <div class="col-span-2 bg-slate-800/80 p-3 rounded-lg border border-slate-700/50 flex flex-col items-center justify-center text-center">
                    <h4 class="text-[10px] font-bold text-yellow-400 uppercase mb-2 flex items-center gap-1"><i class="fa-solid fa-mug-hot"></i> Traktir Kopi</h4>
                    <div class="bg-white p-1 rounded-lg mb-1 shadow-lg"><img src="IMG-20260130-WA0023.jpg" onerror="this.onerror=null; this.src='https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=SupportMe';" alt="QRIS" class="w-20 h-20 object-contain"></div>
                </div>
                <div class="col-span-3 bg-slate-800/50 p-3 rounded-lg border border-slate-700/50 flex flex-col justify-center">
                    <h4 class="text-[10px] font-bold text-sky-400 uppercase mb-2"><i class="fa-solid fa-gauge"></i> Limit Gratis</h4>
                    <ul class="text-[9px] text-slate-400 space-y-2"><li class="flex justify-between border-b border-slate-700/50 pb-1"><span>‚ö° Kecepatan:</span> <span class="font-mono text-emerald-400">~15x / menit</span></li><li class="flex justify-between border-b border-slate-700/50 pb-1"><span>üìÖ Harian:</span> <span class="font-mono text-emerald-400">~1.500x / hari</span></li></ul>
               </div>
            </div>
        </div>

        <footer class="border-t border-slate-700/50 bg-slate-900/50 mt-6 py-6">
            <div class="max-w-4xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center text-[10px] text-slate-500 gap-4">
                <div>&copy; 2026 Lintas Nusa AI. All rights reserved.</div>
                <div class="flex gap-6 font-medium"><button onclick="navigateTo('privacy')" class="hover:text-sky-400">Privacy Policy</button><button onclick="navigateTo('about')" class="hover:text-sky-400">About</button><button onclick="navigateTo('contact')" class="hover:text-sky-400">Contact</button></div>
            </div>
        </footer>

    <!-- AI Writer -->
    <div id="ai-writer-modal" class="modal">
        <div class="glass-panel p-6 max-w-sm w-full mx-4 space-y-4">
            <h3 class="text-lg font-bold text-white flex items-center gap-2"><i class="fa-solid fa-robot text-purple-400"></i> AI Script Writer</h3>
            <div class="grid grid-cols-3 gap-2">
                <button onclick="setAiType('Intro')" class="ai-type-btn bg-slate-800 border border-slate-600 text-slate-300 text-xs py-2 rounded hover:bg-purple-900/50 hover:text-white">Intro</button>
                <button onclick="setAiType('Outro')" class="ai-type-btn bg-slate-800 border border-slate-600 text-slate-300 text-xs py-2 rounded hover:bg-purple-900/50 hover:text-white">Outro</button>
                <button onclick="setAiType('General')" class="ai-type-btn bg-purple-600/20 border border-purple-500 text-white text-xs py-2 rounded hover:bg-purple-600">Bebas</button>
            </div>
            <textarea id="ai-topic-input" class="w-full h-24 bg-slate-900 border border-slate-600 rounded-xl p-3 text-sm text-white placeholder-slate-600 focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Topik..."></textarea>
            <div class="flex gap-2">
                <button onclick="closeAiWriter()" class="flex-1 bg-slate-700 text-slate-300 py-2 rounded-lg text-sm">Batal</button>
                <button onclick="generateScript()" id="btn-generate-script" class="flex-1 bg-purple-600 text-white py-2 rounded-lg text-sm font-bold">Buat Naskah</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-5 py-3 rounded-full shadow-2xl border border-slate-600 text-xs font-medium opacity-0 pointer-events-none transition-all duration-300 z-50 whitespace-nowrap translate-y-5">Msg</div>

    <script>
        const aiVoices = [ { name: "Kore", gender: "Female", desc: "Calm/Standard" }, { name: "Fenrir", gender: "Male", desc: "Deep/Berat" }, { name: "Puck", gender: "Male", desc: "Energetic/Ceria" }, { name: "Zephyr", gender: "Female", desc: "Professional/News" }, { name: "Aoede", gender: "Female", desc: "Elegant/Anggun" }, { name: "Charon", gender: "Male", desc: "Gravelly/Serak" } ];
        
        // ULTIMATE 50+ STYLE MAP
        const styleCategories = {
            "Emosi Positif": { "cheerfully": "very happy voice", "happy_excited": "highly excited voice", "happy_calm": "calm peaceful voice", "happy_grateful": "grateful voice", "happy_proud": "proud confident voice", "happy_flirty": "flirty playful voice" },
            "Emosi Negatif": { "sadly": "sad voice", "sad_crying": "crying sobbing voice", "sad_depressed": "depressed monotone", "sad_regret": "regretful tone", "angry": "angry voice", "angry_scream": "screaming in anger", "angry_cold": "cold furious tone" },
            "Takut & Tegang": { "scared": "scared trembling voice", "fear_panic": "panicked breathless voice", "whisper": "soft whisper" },
            "Anime & Kartun": { "anime_boy": "spirited anime boy", "anime_girl": "cute anime girl voice", "tsundere": "tsundere style", "yandere": "yandere style", "ara_ara": "mature onee-san voice", "mecha_pilot": "mecha pilot", "cartoon_hero": "heroic cartoon voice" },
            "Storytelling": { "story_fairytale": "magical storytelling voice", "story_horror": "slow ominous tone", "story_mystery": "hushed mystery tone", "story_history": "documentary tone", "story_epic": "grand epic tone", "story_bedtime": "soothing bedtime whisper" },
            "Drama": { "melodramatic": "dramatic soap-opera style", "heartbroken": "broken sobbing voice", "villain": "sinister villain voice", "inner_monologue": "soft echoey thought voice" },
            "Kreator": { "ad_hype": "high-energy sales hype", "ad_luxury": "sophisticated expensive tone", "podcaster": "friendly podcast tone", "streamer": "loud hype streamer voice", "news": "formal news anchor voice" },
            "Fantasi": { "demon": "deep terrifying demon voice", "knight": "brave noble voice", "princess": "soft elegant princess voice", "monster": "growling monster voice", "ghost": "spooky ghost voice", "robot": "robotic voice", "char_old_man": "old man voice", "char_child": "child voice" }
        };

        const contextCategories = {
            "Konten Video": { "intro": "Intro video", "outro": "Outro video", "unboxing": "Unboxing", "tutorial": "Tutorial", "promo": "Commercial", "vlog": "Vlog", "creepypasta": "Scary story" },
            "Drama": { "soap_opera": "TV Drama", "breakup": "Breakup", "confession": "Secret", "flashback": "Memory", "dying": "Dying" },
            "Aksi & Komedi": { "prank": "Prank", "standup": "Comedy", "fail": "Fail moment", "battle_shout": "War cry", "victory": "Victory" },
            "Bisnis": { "presentation": "Business presentation", "customer_service": "Customer service tone", "negotiation": "Negotiation tone" },
            "Misc": { "announcement": "Public announcement", "sport": "Sports commentary", "weather": "Weather report" }
        };
        // Flatten for Logic
        const styleMap = { "normal": "Speak naturally.", "custom": "custom" };
        for (const cat in styleCategories) { for (const key in styleCategories[cat]) styleMap[key] = `in a ${styleCategories[cat][key]}`; }
        const contextMap = {};
        for (const cat in contextCategories) { for (const key in contextCategories[cat]) contextMap[key] = `Context: ${contextCategories[cat][key]}.`; }
        const modMap = { "deep": "Make voice deeper.", "high": "Make voice higher pitched.", "slow": "Speak slowly.", "fast": "Speak quickly." };

        let mode = 'ai'; let dialogueLines = []; let standardVoices = []; let voiceHistory = []; let loadInterval;
        let selectedAiType = 'General'; let lastMonoBlob = null; let db;
        const synth = window.speechSynthesis;

        const els = {
            textInput: document.getElementById('text-input'), voiceSelect: document.getElementById('voice-select'), aiConfig: document.getElementById('ai-config'), aiControls: document.getElementById('ai-controls'),
            stdControls: document.getElementById('standard-controls'), voiceDesc: document.getElementById('voice-desc'), refreshBtn: document.getElementById('refresh-voices-btn'), styleSelect: document.getElementById('style-select'),
            contextSelect: document.getElementById('context-select'), modSelect: document.getElementById('voice-mod-select'), langSelect: document.getElementById('ai-language-select'), customPromptContainer: document.getElementById('custom-prompt-container'),
            customPromptInput: document.getElementById('custom-prompt-input'), debugContainer: document.getElementById('debug-container'), debugPrompt: document.getElementById('debug-prompt'), visualizer: document.getElementById('visualizer'),
            audioPlayer: document.getElementById('audio-player'), statusBar: document.getElementById('status-bar'), historyContainer: document.getElementById('history-container'), historyList: document.getElementById('history-list'), 
            btnDialogDownload: document.getElementById('btn-dialog-download'), aiModal: document.getElementById('ai-writer-modal'), aiTopic: document.getElementById('ai-topic-input'), btnGenScript: document.getElementById('btn-generate-script'),
            btnMonoDownload: document.getElementById('btn-download-mono'), mainApp: document.getElementById('main-app'), staticPages: document.getElementById('static-pages'), staticContents: document.querySelectorAll('.static-content'),
            styleA: document.getElementById('style-a'), styleB: document.getElementById('style-b'), customAContainer: document.getElementById('custom-a-container'), customBContainer: document.getElementById('custom-b-container')
        };

        // --- DATABASE ---
        async function initDB() {
            if (!window.idb) return;
            db = await idb.openDB('VocalForgeDB', 1, { upgrade(db) { db.createObjectStore('history', { keyPath: 'id' }); } });
            loadHistory();
        }
        async function saveToDB(item) { if(db) { await db.put('history', item); loadHistory(); } else { addToHistoryLocal(item); } }
        async function loadHistory() {
            if(!db) return;
            const allItems = await db.getAll('history'); const now = Date.now();
            const validItems = allItems.filter(i => (now - i.timestamp) < 24 * 60 * 60 * 1000);
            for(const item of allItems) { if((now - item.timestamp) >= 24*60*60*1000) await db.delete('history', item.id); }
            voiceHistory = validItems.sort((a,b) => b.timestamp - a.timestamp); renderHistory();
        }
        function addToHistoryLocal(item) { voiceHistory.unshift(item); if (voiceHistory.length > 10) voiceHistory.pop(); renderHistory(); }
        window.clearHistory = async () => { if(db) await db.clear('history'); voiceHistory = []; renderHistory(); };

        function init() {
            // Populate Styles & Contexts
            const populateGroups = (selectId, dataObj, isContext) => {
                const el = document.getElementById(selectId);
                el.innerHTML = isContext ? '<option value="">-- Tidak Ada --</option>' : '<option value="normal">Normal (Natural)</option>';
                for (const [category, items] of Object.entries(dataObj)) {
                    const group = document.createElement('optgroup'); group.label = category;
                    for (const [key, val] of Object.entries(items)) {
                        const opt = document.createElement('option'); opt.value = key; 
                        opt.text = key.replace(/_/g, ' ').replace(/^char /, '').replace(/^ad /, '').replace(/^story /, '').toUpperCase();
                        group.appendChild(opt);
                    }
                    el.appendChild(group);
                }
                if(!isContext) { const c = document.createElement('option'); c.value = 'custom'; c.text = '-- Manual (Custom) --'; el.appendChild(c); }
            };
            populateGroups('style-select', styleCategories, false); populateGroups('style-a', styleCategories, false); populateGroups('style-b', styleCategories, false); populateGroups('context-select', contextCategories, true);

            setEngine('ai'); initDB();
            loadInterval = setInterval(forceReloadVoices, 500); setTimeout(() => clearInterval(loadInterval), 3000);
            if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = populateStandardVoices;
        }

        els.styleA.addEventListener('change', () => { els.customAContainer.classList.toggle('hidden', els.styleA.value !== 'custom'); });
        els.styleB.addEventListener('change', () => { els.customBContainer.classList.toggle('hidden', els.styleB.value !== 'custom'); });
        window.navigateTo = (pageId) => {
            if(pageId === 'home') { els.mainApp.classList.remove('hidden'); els.staticPages.classList.add('hidden'); } 
            else { els.mainApp.classList.add('hidden'); els.staticPages.classList.remove('hidden'); els.staticContents.forEach(el => el.classList.add('hidden')); document.getElementById(pageId + '-content').classList.remove('hidden'); } window.scrollTo(0,0);
        };
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'text-sky-400', 'bg-sky-500/10')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.add('text-slate-400'));
            document.getElementById(`tab-${tab}`).classList.add('active', 'text-sky-400', 'bg-sky-500/10');
            document.getElementById('monologue-section').classList.toggle('hidden', tab !== 'monologue'); document.getElementById('dialogue-section').classList.toggle('hidden', tab !== 'dialogue');
        }
        window.setEngine = (newMode) => { 
            mode = newMode;
            const btnStd = document.getElementById('btn-std'), btnAi = document.getElementById('btn-ai');
            if(mode === 'standard') {
                btnStd.className = "px-3 py-1.5 rounded-md text-[10px] font-bold bg-sky-600 text-white shadow-md transition-all"; btnAi.className = "px-3 py-1.5 rounded-md text-[10px] font-bold text-slate-400 hover:text-white transition-all";
                els.aiConfig.classList.add('hidden'); els.voiceDesc.classList.add('hidden'); els.aiControls.classList.add('hidden'); els.stdControls.classList.remove('hidden'); els.refreshBtn.classList.remove('hidden'); els.btnMonoDownload.classList.add('hidden');
                if(standardVoices.length === 0) forceReloadVoices(); populateStandardVoices();
            } else {
                btnAi.className = "px-3 py-1.5 rounded-md text-[10px] font-bold bg-sky-600 text-white shadow-md transition-all"; btnStd.className = "px-3 py-1.5 rounded-md text-[10px] font-bold text-slate-400 hover:text-white transition-all";
                els.aiConfig.classList.remove('hidden'); els.voiceDesc.classList.remove('hidden'); els.aiControls.classList.remove('hidden'); els.stdControls.classList.add('hidden'); els.refreshBtn.classList.add('hidden');
                if(lastMonoBlob) els.btnMonoDownload.classList.remove('hidden');
                els.voiceSelect.innerHTML = ''; aiVoices.forEach(v => { const opt = document.createElement("option"); opt.value = v.name; opt.text = `‚ú® ${v.name} (${v.desc})`; els.voiceSelect.add(opt); }); updateVoiceDesc();
            }
        };
        function updateVoiceDesc() { const val = els.voiceSelect.value; const v = aiVoices.find(x => x.name === val); if(v) els.voiceDesc.textContent = `Style: ${v.desc}`; }
        window.openAiWriter = (source) => { els.aiModal.classList.add('show'); els.aiModal.dataset.source = source || 'monologue'; }; window.closeAiWriter = () => els.aiModal.classList.remove('show');
        window.setAiType = (type) => { selectedAiType = type; };
        function cleanScriptOutput(text) { return text.replace(/[\(\[\*].*?[\)\]\*]/g, '').replace(/^(Naskah|Script|Intro|Outro):/i, '').trim(); }

        window.generateScript = async () => {
            const topic = els.aiTopic.value.trim(); const apiKey = document.getElementById('api-key').value.trim();
            if(!topic || !apiKey) return showToast("Isi topik & API Key!");
            els.btnGenScript.innerHTML = '<div class="loader"></div>'; els.btnGenScript.disabled = true;
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const resp = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents: [{ parts: [{ text: `Write short script in Indonesian for: ${topic}` }] }] }) });
                const data = await resp.json();
                let text = cleanScriptOutput(data.candidates[0].content.parts[0].text);
                if(els.aiModal.dataset.source === 'dialogue') document.getElementById('line-input').value = text; else els.textInput.value = text;
                closeAiWriter();
            } catch(e) { showToast(e.message); } finally { els.btnGenScript.innerHTML = 'Buat Naskah'; els.btnGenScript.disabled = false; }
        };

        document.getElementById('speak-btn').onclick = async () => {
            const text = els.textInput.value.trim(); if (!text) return showToast("Masukkan teks!"); setLoading(document.getElementById('speak-btn'), true);
            if (mode === 'standard') playStandard(text); else { try { const blob = await playAI(text); if(blob) { lastMonoBlob = blob; els.btnMonoDownload.classList.remove('hidden'); saveToDB({ id: Date.now(), text, voice: els.voiceSelect.value, style: els.styleSelect.value, blob, timestamp: Date.now() }); } } catch(e) { console.error(e); } finally { setLoading(document.getElementById('speak-btn'), false); } }
        };
        window.downloadLastAudio = () => { if(lastMonoBlob) downloadBlob(lastMonoBlob, `monologue_${Date.now()}.wav`); };

        async function playAI(text, specificVoice, specificStyle, retryCount = 0) {
            const apiKey = document.getElementById('api-key').value.trim(); if(!apiKey) return showToast("‚ö†Ô∏è Masukkan API Key!");
            const vName = specificVoice || els.voiceSelect.value; const sKey = specificStyle || els.styleSelect.value;
            let instruction = `Speak in ${els.langSelect.value}.`;
            if (sKey === 'custom') instruction += els.customPromptInput.value;
            else if (specificStyle && specificStyle.startsWith('Custom:')) instruction += specificStyle.replace('Custom:', '');
            else instruction += styleMap[sKey] || "";
            if(!specificVoice) { if(els.contextSelect.value) instruction += " " + contextMap[els.contextSelect.value]; if(els.modSelect.value) instruction += " " + modMap[els.modSelect.value]; }

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                const resp = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents: [{ parts: [{ text: `${instruction} Content: "${text}"` }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: vName } } } } }) });
                if (resp.status === 429 && retryCount < 3) { updateStatus(`Limit Hit. Retry ${retryCount+1}...`); await new Promise(r => setTimeout(r, 10000)); return playAI(text, specificVoice, specificStyle, retryCount+1); }
                const data = await resp.json();
                if (!data.candidates || !data.candidates[0]) throw new Error("Gagal generate. Cek API Key/Kuota.");
                const blob = base64ToBlob(data.candidates[0].content.parts[0].inlineData.data);
                if(!specificVoice) playBlob(blob); return blob;
            } catch (e) { showToast(e.message); throw e; }
        }
        
        function playStandard(text) {
            if (synth.speaking) synth.cancel(); const utter = new SpeechSynthesisUtterance(text);
            const v = standardVoices.find(x => x.name === els.voiceSelect.value); if(v) utter.voice = v;
            utter.pitch = document.getElementById('pitch').value; utter.rate = document.getElementById('rate').value;
            utter.onstart = () => els.visualizer.classList.add('animating'); utter.onend = () => { setLoading(document.getElementById('speak-btn'), false); els.visualizer.classList.remove('animating'); };
            synth.speak(utter); els.btnMonoDownload.classList.add('hidden'); lastMonoBlob = null;
        }

        function renderChat() {
            const container = document.getElementById('chat-container'); container.innerHTML = dialogueLines.length === 0 ? '<div class="text-center text-slate-500 text-xs mt-10">Belum ada percakapan</div>' : '';
            dialogueLines.forEach((line, index) => {
                const div = document.createElement('div'); div.className = `chat-row speaker-${line.speaker.toLowerCase()}`; div.id = `chat-line-${index}`;
                div.innerHTML = `<div class="chat-bubble shadow-md group relative"><button onclick="deleteLine(${index})" class="delete-btn"><i class="fa-solid fa-times"></i></button><strong class="block text-[10px] opacity-70 mb-1">${line.speaker==='A'?'Speaker A':'Speaker B'}</strong>${line.text}</div>`; container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
            if(dialogueLines.some(l => l.audio)) els.btnDialogDownload.classList.remove('hidden'); else els.btnDialogDownload.classList.add('hidden');
        }

        window.addLine = () => { const s = document.getElementById('speaker-select').value; const t = document.getElementById('line-input').value.trim(); if(!t) return; dialogueLines.push({ speaker: s, text: t, audio: null }); renderChat(); document.getElementById('line-input').value = ''; };
        window.deleteLine = (index) => { dialogueLines.splice(index, 1); renderChat(); };
        window.clearChat = () => { dialogueLines = []; renderChat(); };
        window.playDialogue = async () => {
            if(dialogueLines.length === 0) return showToast("Isi dialog!"); const btn = document.getElementById('btn-dialog-play'); setLoading(btn, true); els.statusBar.classList.remove('hidden');
            try {
                let queue = [];
                for(let i=0; i<dialogueLines.length; i++) {
                    const line = dialogueLines[i]; if(i>0) await new Promise(r => setTimeout(r, 4000));
                    const v = document.getElementById(line.speaker === 'A' ? 'voice-a' : 'voice-b').value;
                    let s = document.getElementById(line.speaker === 'A' ? 'style-a' : 'style-b').value;
                    if(s === 'custom') s = 'Custom:' + document.getElementById(line.speaker === 'A' ? 'custom-prompt-a' : 'custom-prompt-b').value;
                    if (line.audio) queue.push(line.audio); else { const blob = await playAI(line.text, v, s); line.audio = blob; queue.push(blob); }
                }
                for(let i=0; i<queue.length; i++) {
                    const bubbles = document.querySelectorAll('.chat-bubble'); bubbles.forEach(b => b.classList.remove('playing-now'));
                    if(document.getElementById(`chat-line-${i}`)) document.getElementById(`chat-line-${i}`).querySelector('.chat-bubble').classList.add('playing-now');
                    await new Promise(resolve => playBlob(queue[i], resolve));
                }
            } catch(e) { showToast(e.message); } finally { setLoading(btn, false); els.statusBar.classList.add('hidden'); }
        }

        window.exportDialogue = async () => {
             if(!dialogueLines.some(l => l.audio)) return showToast("Play scene dulu!");
             try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)(); const buffers = [];
                for(const line of dialogueLines) { if(!line.audio) continue; const ab = await line.audio.arrayBuffer(); const b = await audioCtx.decodeAudioData(ab); buffers.push(b); }
                const totalLen = buffers.reduce((acc, b) => acc + b.length, 0); const out = audioCtx.createBuffer(1, totalLen, buffers[0].sampleRate);
                const data = out.getChannelData(0); let off = 0; for(const buff of buffers) { data.set(buff.getChannelData(0), off); off += buff.length; }
                downloadBlob(audioBufferToWavBlob(out), "dialogue_scene.wav");
            } catch(e) { showToast("Gagal Export"); }
        };

        function base64ToBlob(b64) { const bin = atob(b64); const len = bin.length; const bytes = new Uint8Array(len); for (let i = 0; i < len; i++) bytes[i] = bin.charCodeAt(i); return pcmToWav(bytes, 24000); }
        function pcmToWav(pcm, rate) {
            const h = new ArrayBuffer(44); const v = new DataView(h); const wS = (o, s) => { for(let i=0;i<s.length;i++) v.setUint8(o+i, s.charCodeAt(i)); };
            wS(0,'RIFF'); v.setUint32(4,36+pcm.length,true); wS(8,'WAVEfmt '); v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,1,true); v.setUint32(24,rate,true); v.setUint32(28,rate*2,true); v.setUint16(32,2,true); v.setUint16(34,16,true); wS(36,'data'); v.setUint32(40,pcm.length,true);
            const b = new Uint8Array(44+pcm.length); b.set(new Uint8Array(h),0); b.set(pcm,44); return new Blob([b],{type:'audio/wav'});
        }
        function audioBufferToWavBlob(buffer) {
            const len = buffer.length * 2 + 44; const buf = new ArrayBuffer(len); const v = new DataView(buf); const ch = buffer.getChannelData(0); let p = 0;
            const wS = (o, s) => { for(let i=0;i<s.length;i++) v.setUint8(o+i, s.charCodeAt(i)); };
            wS(0,'RIFF'); v.setUint32(4,len-8,true); wS(8,'WAVEfmt '); v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,1,true); v.setUint32(24,buffer.sampleRate,true); v.setUint32(28,buffer.sampleRate*2,true); v.setUint16(32,2,true); v.setUint16(34,16,true); wS(36,'data'); v.setUint32(40,ch.length*2,true); p=44;
            for(let i=0;i<ch.length;i++) { let s = Math.max(-1, Math.min(1, ch[i])); s = (s<0 ? s*0x8000 : s*0x7FFF)|0; v.setInt16(p,s,true); p+=2; }
            return new Blob([v],{type:'audio/wav'});
        }
        function playBlob(blob, onEnd) { const u = URL.createObjectURL(blob); const a = document.getElementById('audio-player'); a.src = u; a.play(); if(onEnd) a.onended = onEnd; }
        function downloadBlob(blob, filename) { const u = URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display='none'; a.href=u; a.download=filename; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(u); }
        function setLoading(btn, load, txt) { btn.disabled = load; btn.innerHTML = load ? `<div class="loader mr-2"></div>` : (txt || `<i class="fa-solid fa-play mr-1"></i> Generate & Play`); }
        function showToast(m) { const t=document.getElementById('toast'); t.textContent=m; t.classList.remove('opacity-0', 'translate-y-5'); setTimeout(()=>t.classList.add('opacity-0', 'translate-y-5'), 3000); }
        function clearText() { document.getElementById('text-input').value = ''; }
        function updateStatus(msg) { const bar = document.getElementById('status-bar'); bar.classList.remove('hidden'); bar.textContent = msg; }
        window.forceReloadVoices = () => { const current = synth.getVoices(); if (current.length > 0) { standardVoices = current; if(mode === 'standard') populateStandardVoices(); } };
        function populateStandardVoices() {
            if(mode !== 'standard') return; standardVoices = synth.getVoices();
            if(standardVoices.length === 0) { if (!els.voiceSelect.innerHTML.includes("Tidak ada")) { els.voiceSelect.innerHTML = ''; const opt = document.createElement('option'); opt.text = "Tidak ada suara (Tekan tombol üîÑ)"; els.voiceSelect.add(opt); } } 
            else { const prev = els.voiceSelect.value; els.voiceSelect.innerHTML = ''; let sorted = [...standardVoices].sort((a,b) => a.name.localeCompare(b.name)); sorted.forEach(v => { if(v.lang.includes('id') || v.lang.includes('in_ID')) { const opt = document.createElement('option'); opt.value = v.name; opt.text = `üáÆüá© ${v.name}`; els.voiceSelect.add(opt); } }); if(els.voiceSelect.options.length === 0) { sorted.forEach(v => { if(!v.lang.includes('id') && !v.lang.includes('in_ID')) { const opt = document.createElement('option'); opt.value = v.name; opt.text = v.name; els.voiceSelect.add(opt); } }); } if(prev) els.voiceSelect.value = prev; }
        }
        function addToHistory(text, voice, style, blob) {
            const id = Date.now(); voiceHistory.unshift({ id, text, voice, style, blob }); if (voiceHistory.length > 10) voiceHistory.pop(); renderHistory();
        }

        els.styleSelect.addEventListener('change', () => { els.customPromptContainer.classList.toggle('hidden', els.styleSelect.value !== 'custom'); document.getElementById('context-container').classList.toggle('hidden', els.styleSelect.value === 'custom'); });
        window.toggleDebug = () => els.debugContainer.classList.toggle('hidden'); window.clearText = () => els.textInput.value = '';

        init();
    </script>
</body>
</html>