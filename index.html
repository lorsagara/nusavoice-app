<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VocalForge Pro - Lintas Nusa AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }

        .range-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px; 
            background: #334155;
            border-radius: 5px;
            outline: none;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px; 
            height: 18px;
            border-radius: 50%;
            background: #38bdf8;
            cursor: pointer;
            transition: transform .1s;
        }
        
        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #38bdf8;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .animating .bar {
            animation: bounce 0.5s infinite ease-in-out alternate;
        }
        .bar {
            width: 6px; height: 10px; background: #38bdf8; border-radius: 3px;
        }
        @keyframes bounce {
            100% { height: 30px; opacity: 1; background: #bae6fd; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col pb-10">

    <!-- Navbar dengan Logo Custom & Fallback -->
    <nav class="border-b border-slate-700 bg-slate-900/95 sticky top-0 z-50 backdrop-blur-md">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <img src="1000063032.png" 
                         onerror="this.onerror=null; this.src='https://cdn-icons-png.flaticon.com/512/4712/4712009.png';" 
                         alt="Lintas Nusa AI" 
                         class="h-12 w-12 object-contain rounded-full border border-sky-500/30 shadow-lg shadow-sky-500/20 bg-slate-800">
                    
                    <div>
                        <span class="font-bold text-lg block leading-tight text-white">VocalForge <span class="text-sky-400">Pro</span></span>
                        <span class="text-[10px] text-slate-400 block leading-tight">Lintas Nusa AI Edition</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow p-4 max-w-3xl mx-auto w-full space-y-6">

        <!-- Engine Switcher -->
        <div class="glass-panel p-4 flex flex-col sm:flex-row justify-between items-center gap-4 border-l-4 border-sky-500">
            <div>
                <h2 class="font-bold text-white">Mode Mesin Suara</h2>
                <p class="text-xs text-slate-400">Pilih mesin untuk mengaktifkan fitur kontrol yang berbeda.</p>
            </div>
            
            <div class="flex items-center bg-slate-900 rounded-full p-1 border border-slate-700">
                <button onclick="setMode('standard')" id="btn-std" class="px-4 py-2 rounded-full text-xs font-bold transition-all text-slate-400 hover:text-white">
                    <i class="fa-solid fa-mobile-screen"></i> HP (Offline)
                </button>
                <button onclick="setMode('ai')" id="btn-ai" class="px-4 py-2 rounded-full text-xs font-bold transition-all bg-sky-600 text-white shadow-lg">
                    <i class="fa-solid fa-cloud"></i> Google AI
                </button>
            </div>
        </div>

        <!-- API Key Input (Cleaner Design) -->
        <div id="ai-config" class="glass-panel p-5 border border-sky-500/30 bg-sky-900/10 fade-in shadow-lg relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-24 h-24 bg-sky-500/10 rounded-full blur-xl pointer-events-none"></div>

            <label class="block text-xs font-bold text-sky-100 mb-3 flex items-center gap-2">
                <span class="bg-sky-500/20 text-sky-400 p-1.5 rounded-md"><i class="fa-brands fa-google"></i></span>
                GOOGLE GEMINI API CONFIG
            </label>

            <div class="flex gap-0 rounded-xl shadow-sm border border-slate-600 focus-within:border-sky-500 focus-within:ring-1 focus-within:ring-sky-500 transition-all bg-slate-900/80">
                <div class="pl-3 flex items-center pointer-events-none">
                    <i class="fa-solid fa-key text-slate-500 text-xs"></i>
                </div>
                <input type="password" id="api-key" value="" placeholder="Tempel API Key di sini (AIza...)" 
                    class="flex-grow bg-transparent border-none text-white text-sm px-3 py-3 focus:ring-0 placeholder-slate-500 outline-none w-full">
                <div class="w-px bg-slate-700 my-2"></div>
                <a href="https://aistudio.google.com/app/apikey" target="_blank" 
                   class="flex items-center px-4 py-2 bg-slate-800/50 hover:bg-slate-700 text-sky-400 text-xs font-bold transition-colors whitespace-nowrap rounded-r-xl group" title="Buka Google AI Studio">
                    <span>Get Key</span>
                    <i class="fa-solid fa-arrow-up-right-from-square ml-2 text-[10px] group-hover:translate-x-0.5 transition-transform"></i>
                </a>
            </div>
            
            <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
                <div class="flex items-center gap-2 text-[10px] text-slate-400 bg-slate-800/40 px-3 py-2 rounded-lg border border-slate-700/30">
                    <span class="flex-shrink-0 w-4 h-4 rounded-full bg-slate-700 text-sky-400 flex items-center justify-center font-bold text-[9px]">1</span>
                    Login Google AI Studio
                </div>
                <div class="flex items-center gap-2 text-[10px] text-slate-400 bg-slate-800/40 px-3 py-2 rounded-lg border border-slate-700/30">
                    <span class="flex-shrink-0 w-4 h-4 rounded-full bg-slate-700 text-sky-400 flex items-center justify-center font-bold text-[9px]">2</span>
                    Klik "Create API Key" & Copy
                </div>
            </div>
            <p class="text-[9px] text-emerald-500/80 mt-2 flex items-center gap-1.5 ml-1">
                <i class="fa-solid fa-shield-halved"></i> Key aman & tersimpan lokal di browser.
            </p>
        </div>

        <!-- Input Area -->
        <div class="glass-panel p-4 shadow-xl">
            <div class="flex justify-between items-center mb-2">
                <label class="text-xs font-bold text-slate-400 uppercase">Naskah Voiceover</label>
                <button onclick="clearText()" class="text-xs text-red-400 hover:text-red-300"><i class="fa-solid fa-trash"></i> Bersihkan</button>
            </div>
            <textarea id="text-input" class="w-full h-32 bg-slate-800/50 text-slate-200 border border-slate-600 rounded-xl p-3 focus:ring-2 focus:ring-sky-500 outline-none resize-none placeholder-slate-500" placeholder="Tulis naskah Drama, Komedi, atau Konten Kreator Anda di sini..."></textarea>
            <div class="flex justify-end mt-2">
                <span id="charCount" class="text-xs text-slate-500">0 chars</span>
            </div>
        </div>

        <!-- Controls Panel -->
        <div class="glass-panel p-4 shadow-xl space-y-4">
            
            <!-- Voice Actor -->
            <div>
                <label class="block text-xs font-bold text-slate-400 mb-1 uppercase">Voice Actor</label>
                <div class="flex gap-2">
                    <select id="voice-select" class="w-full bg-slate-800 border border-slate-600 text-white text-sm rounded-lg p-3 outline-none focus:border-sky-500">
                        <!-- Populated by JS -->
                    </select>
                    <!-- Tombol Refresh Khusus Android -->
                    <button id="refresh-voices-btn" onclick="forceReloadVoices()" class="hidden w-12 bg-slate-700 hover:bg-slate-600 rounded-lg border border-slate-600 text-sky-400 flex items-center justify-center transition-all" title="Refresh Daftar Suara">
                        <i class="fa-solid fa-sync"></i>
                    </button>
                </div>
                <p id="voice-desc" class="text-[10px] text-sky-400 mt-1 italic hidden fade-in"></p>
            </div>

            <!-- AI CONTROLS: ULTIMATE EDITION -->
            <div id="ai-controls" class="fade-in space-y-4 bg-sky-900/20 p-4 rounded-xl border border-sky-500/20">
                
                <!-- Language Selector -->
                <div>
                    <label class="block text-xs font-bold text-sky-300 mb-1 uppercase">Target Bahasa</label>
                    <select id="ai-language-select" class="w-full bg-slate-900 border border-slate-600 text-white text-sm rounded-lg p-2 outline-none focus:border-sky-500">
                        <option value="Indonesian">ğŸ‡®ğŸ‡© Bahasa Indonesia</option>
                        <option value="Javanese">ğŸ‡®ğŸ‡© Bahasa Jawa (Logat)</option>
                        <option value="Sundanese">ğŸ‡®ğŸ‡© Bahasa Sunda (Logat)</option>
                        <option value="English">ğŸ‡ºğŸ‡¸ English</option>
                        <option value="Japanese">ğŸ‡¯ğŸ‡µ Japanese</option>
                        <option value="Korean">ğŸ‡°ğŸ‡· Korean</option>
                        <option value="Chinese">ğŸ‡¨ğŸ‡³ Chinese</option>
                    </select>
                </div>

                <!-- Modifikasi Suara -->
                <div>
                    <label class="block text-xs font-bold text-sky-300 mb-1 uppercase">Modifikasi Nada & Kecepatan</label>
                    <select id="voice-mod-select" class="w-full bg-slate-900 border border-slate-600 text-white text-sm rounded-lg p-2 outline-none focus:border-sky-500">
                        <option value="">Normal (Standar)</option>
                        <option value="deep">ğŸ”‰ Nada Berat (Deep)</option>
                        <option value="high">ğŸ”Š Nada Tinggi (High)</option>
                        <option value="slow">ğŸ¢ Bicara Lambat</option>
                        <option value="fast">ğŸ‡ Bicara Cepat</option>
                    </select>
                </div>

                <!-- Style Selector -->
                <div>
                    <label class="block text-xs font-bold text-sky-300 mb-1 uppercase">Karakter & Emosi</label>
                    <select id="style-select" class="w-full bg-slate-900 border border-slate-600 text-white text-sm rounded-lg p-2 outline-none focus:border-sky-500">
                        <option value="normal">Normal (Natural)</option>
                        
                        <optgroup label="Emosi & Ekspresi">
                            <option value="cheerfully">ğŸ˜„ Ceria / Bahagia</option>
                            <option value="sadly">ğŸ˜¢ Sedih / Menangis</option>
                            <option value="excitedly">ğŸ”¥ Semangat / Hype</option>
                            <option value="angrily">ğŸ˜¡ Marah / Ngegas</option>
                            <option value="scared">ğŸ˜± Takut / Gugup</option>
                            <option value="whisper">ğŸ¤« Berbisik (ASMR)</option>
                        </optgroup>

                        <optgroup label="Drama & Sinetron">
                            <option value="melodramatic">ğŸ­ Melodramatis (Lebay)</option>
                            <option value="heartbroken">ğŸ’” Patah Hati (Sedih Berat)</option>
                            <option value="villain">ğŸ˜ˆ Antagonis / Licik</option>
                            <option value="confused">ğŸ¤” Bingung / Ragu</option>
                            <option value="inner_monologue">ğŸ’­ Suara Hati (Gumam)</option>
                        </optgroup>

                        <optgroup label="Komedi & Hiburan">
                            <option value="comedian">ğŸ¤ Stand-up Comedian</option>
                            <option value="laughing">ğŸ˜‚ Sambil Tertawa</option>
                            <option value="goofy">ğŸ¤ª Konyol / Kartun</option>
                            <option value="sarcastic">ğŸ˜ Sarkastik / Nyindir</option>
                        </optgroup>

                        <optgroup label="Konten Kreator">
                            <option value="podcaster">ğŸ™ï¸ Podcaster Santai</option>
                            <option value="streamer">ğŸ® Game Streamer (Ngegas)</option>
                            <option value="reviewer">ğŸ“± Tech Reviewer (Cerdas)</option>
                            <option value="motivator">ğŸŒŸ Motivator (Inspiratif)</option>
                            <option value="news">ğŸ“° Pembaca Berita</option>
                        </optgroup>

                        <optgroup label="Karakter Fantasi">
                            <option value="demon">ğŸ”¥ Demon King</option>
                            <option value="knight">âš”ï¸ Medieval Knight</option>
                            <option value="princess">ğŸ‘‘ Princess</option>
                            <option value="wizard">ğŸ§™â€â™‚ï¸ Wizard</option>
                            <option value="monster">ğŸ‘¹ Monster</option>
                            <option value="ghost">ğŸ‘» Hantu</option>
                            <option value="robot">ğŸ¤– Robot</option>
                        </optgroup>
                        
                        <option value="custom">-- Instruksi Manual (Custom) --</option>
                    </select>
                </div>

                <!-- Context Selector -->
                <div id="context-selector-container">
                    <label class="block text-xs font-bold text-sky-300 mb-1 uppercase">Konteks Situasi</label>
                    <select id="context-select" class="w-full bg-slate-900 border border-slate-600 text-white text-sm rounded-lg p-2 outline-none focus:border-sky-500">
                        <option value="">-- Tidak Ada --</option>
                        
                        <optgroup label="Konten Video & Medsos">
                            <option value="intro">ğŸ‘‹ Intro YouTube / Podcast</option>
                            <option value="outro">ğŸ™ Outro / Closing</option>
                            <option value="unboxing">ğŸ“¦ Unboxing Produk</option>
                            <option value="tutorial">ğŸ“š Tutorial Step-by-Step</option>
                            <option value="promo">âš¡ Iklan / Promo Cepat</option>
                            <option value="vlog">ğŸ¤³ Vlog Casual</option>
                            <option value="creepypasta">ğŸ‘» Cerita Horor</option>
                        </optgroup>

                        <optgroup label="Drama & Cerita">
                            <option value="soap_opera">ğŸ“º Adegan Sinetron</option>
                            <option value="breakup">ğŸ’” Momen Putus Cinta</option>
                            <option value="confession">ğŸ¤« Pengakuan Rahasia</option>
                            <option value="flashback">ğŸ•°ï¸ Flashback Masa Lalu</option>
                            <option value="dying">ğŸ’€ Sekarat / Dramatis</option>
                        </optgroup>

                        <optgroup label="Komedi & Aksi">
                            <option value="prank">ğŸ¤¡ Prank / Jahil</option>
                            <option value="standup">ğŸ¤ Panggung Komedi</option>
                            <option value="fail">ğŸ¤¦ Momen Apes / Fail</option>
                            <option value="battle_shout">âš”ï¸ Teriakan Perang</option>
                            <option value="victory">ğŸ† Pidato Kemenangan</option>
                        </optgroup>
                    </select>
                </div>
                
                <!-- Custom Prompt (Hidden) -->
                <div id="custom-prompt-container" class="hidden">
                    <label class="block text-[10px] font-bold text-slate-400 mb-1">Custom Prompt (English)</label>
                    <input type="text" id="custom-prompt-input" placeholder="e.g. Speak like a pirate..." class="w-full bg-slate-900 border border-slate-600 text-white text-sm rounded-lg p-2 outline-none">
                </div>

                <!-- Debug Prompt View -->
                <div id="debug-container" class="hidden mt-2 p-2 bg-black/30 rounded border border-slate-700">
                    <p class="text-[10px] text-slate-400 font-mono mb-1">Prompt yang dikirim ke AI:</p>
                    <textarea id="debug-prompt" readonly class="w-full h-16 bg-transparent text-[10px] text-green-400 font-mono resize-none outline-none"></textarea>
                </div>
            </div>

            <!-- STANDARD CONTROLS -->
            <div id="standard-controls" class="hidden grid grid-cols-2 gap-4 pt-2">
                <div class="bg-slate-800/50 p-2 rounded-lg border border-slate-700">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Kecepatan</label>
                    <input type="range" id="rate" min="0.5" max="2" value="1" step="0.1" class="range-slider">
                </div>
                <div class="bg-slate-800/50 p-2 rounded-lg border border-slate-700">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Nada</label>
                    <input type="range" id="pitch" min="0" max="2" value="1" step="0.1" class="range-slider">
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex gap-2 mt-2">
                <button id="speak-btn" class="flex-grow bg-gradient-to-r from-sky-600 to-blue-600 hover:from-sky-500 hover:to-blue-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-2">
                    <i class="fa-solid fa-play"></i> Generate & Play
                </button>
                <button onclick="toggleDebug()" class="bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white px-4 rounded-xl border border-slate-600" title="Lihat Prompt Asli">
                    <i class="fa-solid fa-eye"></i>
                </button>
            </div>

            <!-- Visualizer & Audio -->
            <div class="flex justify-center h-8 gap-1 items-end opacity-50 transition-opacity duration-300" id="visualizer">
                <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
            </div>
            <audio id="audio-player" class="w-full hidden" controls></audio>
        </div>

        <!-- Info Panel (Combined & Restored) -->
        <div class="glass-panel p-4 border-t-4 border-slate-600 space-y-5">
            
            <!-- Tips Karakter (Dikembalikan) -->
            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700">
                <h4 class="text-xs font-bold text-amber-400 uppercase mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Tips Karakter Fantasi
                </h4>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 text-[10px] text-slate-300">
                    <div class="bg-slate-800 p-2 rounded border border-slate-700/50">
                        <strong class="block text-red-400 mb-1"><i class="fa-solid fa-fire"></i> Demon King</strong>
                        Pilih suara <b>Fenrir/Charon</b> + Style <b>Demon</b>.
                    </div>
                    <div class="bg-slate-800 p-2 rounded border border-slate-700/50">
                        <strong class="block text-pink-400 mb-1"><i class="fa-solid fa-crown"></i> Princess</strong>
                        Pilih suara <b>Aoede/Kore</b> + Style <b>Princess</b>.
                    </div>
                    <div class="bg-slate-800 p-2 rounded border border-slate-700/50">
                        <strong class="block text-blue-400 mb-1"><i class="fa-solid fa-shield-halved"></i> Knight</strong>
                        Pilih suara <b>Zephyr/Fenrir</b> + Style <b>Knight</b>.
                    </div>
                </div>
            </div>

            <!-- Limit Info -->
            <div>
                <h4 class="text-xs font-bold text-sky-300 uppercase mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-triangle-exclamation"></i> Info Limit Gratis
                </h4>
                <div class="flex gap-4 text-[10px] text-slate-400 bg-slate-800/30 p-2 rounded">
                    <div><span class="text-emerald-400 font-bold">Kecepatan:</span> ~15 x / menit</div>
                    <div><span class="text-emerald-400 font-bold">Harian:</span> ~1.500 x Generate</div>
                </div>
                <p class="text-[9px] text-slate-500 mt-1 italic">*Kuota reset setiap hari pukul 14.00/15.00 WIB.</p>
            </div>
        </div>

    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-2xl border border-slate-600 text-sm opacity-0 pointer-events-none transition-opacity duration-300 z-50 whitespace-nowrap">Msg</div>

    <script>
        // --- COMPLETE PROMPT MAPS ---
        
        const styleMap = {
            "normal": "Speak naturally.",
            "cheerfully": "in a very happy, cheerful, and energetic voice",
            "sadly": "in a sad, melancholic, and tearful voice",
            "excitedly": "in an excited, high-energy, and enthusiastic voice",
            "angrily": "in an angry, loud, and furious voice",
            "scared": "in a scared, trembling, and nervous voice",
            "whisper": "in a soft, breathy whisper",
            "melodramatic": "in an exaggerated, dramatic soap-opera style",
            "heartbroken": "in a broken, sobbing, and deeply sorrowful voice",
            "villain": "in a sinister, cunning, and calculating villain voice",
            "confused": "in a confused, hesitant, and questioning tone",
            "inner_monologue": "in a soft, echoey, introspective internal voice",
            "comedian": "like a stand-up comedian with punchy delivery",
            "laughing": "while suppressing laughter and giggling",
            "goofy": "in a silly, goofy, cartoonish voice",
            "sarcastic": "in a dry, witty, and sarcastic tone",
            "podcaster": "in a friendly, conversational, and warm podcaster tone",
            "streamer": "in a hype, loud, and fast-paced streamer voice",
            "reviewer": "in a crisp, articulate, and knowledgeable tech-reviewer tone",
            "motivator": "in an inspiring, powerful, and confident voice",
            "news": "in a formal, steady, and professional news anchor voice",
            "demon": "in a deep, guttural, and terrifying demon voice",
            "knight": "in a brave, resonant, and authoritative knight voice",
            "princess": "in a soft, elegant, and high-pitched princess voice",
            "wizard": "in a raspy, old, creaky, and wise voice",
            "monster": "in a growling, beast-like monster voice",
            "ghost": "in a breathy, hollow, spectral, and eerie voice",
            "robot": "in a flat, staccato, monotone robotic rhythm"
        };

        const modMap = {
            "deep": "Make the voice noticeably deeper and heavier.",
            "high": "Make the voice noticeably higher pitched and lighter.",
            "slow": "Speak very slowly, enunciating every syllable.",
            "fast": "Speak very quickly and rapidly.",
            "slow_deep": "Speak extremely slowly with a massive, deep rumble."
        };

        const contextMap = {
            "intro": "Context: Introducing a video enthusiastically.",
            "outro": "Context: Thanking viewers warmly at the end of a video.",
            "unboxing": "Context: Excitedly unboxing a new product.",
            "tutorial": "Context: Explaining steps clearly and patiently.",
            "promo": "Context: announcing a fast-paced commercial.",
            "vlog": "Context: talking casually to a camera while walking.",
            "creepypasta": "Context: narrating a scary story slowly.",
            "soap_opera": "Context: acting in a dramatic TV scene.",
            "breakup": "Context: having a painful breakup conversation.",
            "confession": "Context: whispering a secret confession.",
            "flashback": "Context: narrating a distant memory.",
            "dying": "Context: speaking final words weakly.",
            "prank": "Context: playing a mischievous prank.",
            "standup": "Context: performing on a comedy stage.",
            "fail": "Context: reacting to a funny accident.",
            "battle_shout": "Context: shouting on a battlefield.",
            "victory": "Context: celebrating a huge win."
        };

        // --- State ---
        let mode = 'ai';
        let standardVoices = [];
        let loadInterval;
        const synth = window.speechSynthesis;
        
        const aiVoices = [
            { name: "Kore", gender: "Female", style: "Calm" },
            { name: "Fenrir", gender: "Male", style: "Deep" },
            { name: "Puck", gender: "Male", style: "Energetic" },
            { name: "Zephyr", gender: "Female", style: "Professional" },
            { name: "Aoede", gender: "Female", style: "Elegant" },
            { name: "Charon", gender: "Male", style: "Gravelly" }
        ];

        // --- Elements ---
        const textInput = document.getElementById('text-input');
        const voiceSelect = document.getElementById('voice-select');
        const speakBtn = document.getElementById('speak-btn');
        const apiKeyInput = document.getElementById('api-key');
        const aiConfig = document.getElementById('ai-config');
        const aiControls = document.getElementById('ai-controls');
        const stdControls = document.getElementById('standard-controls');
        const refreshBtn = document.getElementById('refresh-voices-btn');
        
        const styleSelect = document.getElementById('style-select');
        const langSelect = document.getElementById('ai-language-select');
        const contextSelect = document.getElementById('context-select');
        const voiceModSelect = document.getElementById('voice-mod-select');
        const customPromptContainer = document.getElementById('custom-prompt-container');
        const customPromptInput = document.getElementById('custom-prompt-input');
        const debugContainer = document.getElementById('debug-container');
        const debugPrompt = document.getElementById('debug-prompt');
        
        const visualizer = document.getElementById('visualizer');
        const audioPlayer = document.getElementById('audio-player');
        const voiceDesc = document.getElementById('voice-desc');

        function init() {
            loadInterval = setInterval(forceReloadVoices, 500);
            setTimeout(() => clearInterval(loadInterval), 3000); 
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateStandardVoices;
            }
            setMode('ai');
        }

        window.setMode = (newMode) => {
            mode = newMode;
            updateUI();
            
            const btnStd = document.getElementById('btn-std');
            const btnAi = document.getElementById('btn-ai');
            
            if(mode === 'standard') {
                btnStd.className = "px-4 py-2 rounded-full text-xs font-bold transition-all bg-sky-600 text-white shadow-lg";
                btnAi.className = "px-4 py-2 rounded-full text-xs font-bold transition-all text-slate-400 hover:text-white";
                aiConfig.classList.add('hidden');
                voiceDesc.classList.add('hidden');
                aiControls.classList.add('hidden');
                stdControls.classList.remove('hidden');
                refreshBtn.classList.remove('hidden'); 
                if(standardVoices.length === 0) forceReloadVoices();
            } else {
                btnAi.className = "px-4 py-2 rounded-full text-xs font-bold transition-all bg-sky-600 text-white shadow-lg";
                btnStd.className = "px-4 py-2 rounded-full text-xs font-bold transition-all text-slate-400 hover:text-white";
                aiConfig.classList.remove('hidden');
                voiceDesc.classList.remove('hidden');
                aiControls.classList.remove('hidden');
                stdControls.classList.add('hidden');
                refreshBtn.classList.add('hidden');
            }
        };

        window.toggleDebug = () => { debugContainer.classList.toggle('hidden'); };
        window.forceReloadVoices = () => {
            const currentVoices = synth.getVoices();
            if (currentVoices.length > 0 && (currentVoices.length !== standardVoices.length || voiceSelect.options.length <= 1)) {
                standardVoices = currentVoices;
                if(mode === 'standard') populateStandardVoices();
            }
        };

        styleSelect.addEventListener('change', () => {
            if(styleSelect.value === 'custom') {
                customPromptContainer.classList.remove('hidden');
            } else {
                customPromptContainer.classList.add('hidden');
            }
        });

        function updateUI() {
            if (mode === 'standard') {
                populateStandardVoices();
            } else {
                voiceSelect.innerHTML = ''; 
                aiVoices.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v.name;
                    opt.text = `âœ¨ ${v.name} (${v.gender})`;
                    voiceSelect.add(opt);
                });
                updateVoiceDesc();
            }
        }

        function populateStandardVoices() {
            if(mode !== 'standard') return;
            standardVoices = synth.getVoices();
            if(standardVoices.length === 0) {
                if (!voiceSelect.innerHTML.includes("Tidak ada suara")) {
                    voiceSelect.innerHTML = '';
                    const opt = document.createElement('option');
                    opt.text = "Tidak ada suara (Tekan tombol ğŸ”„)";
                    voiceSelect.add(opt);
                }
            } else {
                const previousSelection = voiceSelect.value;
                voiceSelect.innerHTML = '';
                let sortedVoices = [...standardVoices].sort((a,b) => a.name.localeCompare(b.name));
                let count = 0;
                sortedVoices.forEach(v => {
                    if(v.lang.includes('id') || v.lang.includes('in_ID')) { 
                        const opt = document.createElement('option');
                        opt.value = v.name;
                        opt.text = `ğŸ‡®ğŸ‡© ${v.name}`;
                        voiceSelect.add(opt);
                        count++;
                    }
                });
                if(count === 0 || standardVoices.length < 20) {
                     sortedVoices.forEach(v => {
                        if(!v.lang.includes('id') && !v.lang.includes('in_ID')) {
                            const opt = document.createElement('option');
                            opt.value = v.name;
                            opt.text = v.name;
                            voiceSelect.add(opt);
                        }
                    });
                }
                if (previousSelection) voiceSelect.value = previousSelection;
            }
        }
        
        voiceSelect.addEventListener('change', () => { if(mode === 'ai') updateVoiceDesc(); });

        function updateVoiceDesc() {
            const selectedName = voiceSelect.value;
            const voice = aiVoices.find(v => v.name === selectedName);
            if(voice) voiceDesc.textContent = `Style: ${voice.style}`;
        }

        speakBtn.onclick = async () => {
            const text = textInput.value.trim();
            if (!text) return showToast("Masukkan teks terlebih dahulu!");
            setLoading(true);
            if (mode === 'standard') playStandard(text);
            else await playAI(text);
        };

        function playStandard(text) {
            if (synth.speaking) synth.cancel();
            const utter = new SpeechSynthesisUtterance(text);
            if(voiceSelect.value.includes("Tidak ada suara")) {
                setLoading(false);
                return showToast("Gagal: HP Anda belum memuat suara. Tekan tombol ğŸ”„ di samping.");
            }
            const selectedName = voiceSelect.value;
            const voice = standardVoices.find(v => v.name === selectedName);
            if(voice) utter.voice = voice;
            utter.pitch = document.getElementById('pitch').value;
            utter.rate = document.getElementById('rate').value;
            utter.onstart = () => { visualizer.classList.add('animating'); visualizer.classList.remove('opacity-50'); };
            utter.onend = () => { setLoading(false); visualizer.classList.remove('animating'); visualizer.classList.add('opacity-50'); };
            utter.lang = 'id-ID'; 
            synth.speak(utter);
        }

        async function playAI(text) {
            const key = apiKeyInput.value.trim();
            if (!key) {
                setLoading(false);
                apiKeyInput.classList.add('ring-2', 'ring-red-500');
                setTimeout(() => apiKeyInput.classList.remove('ring-2', 'ring-red-500'), 1000);
                apiKeyInput.focus();
                return showToast("âš ï¸ Masukkan API Key!");
            }

            const voiceName = voiceSelect.value;
            const lang = langSelect.value;
            const styleKey = styleSelect.value;
            const modKey = voiceModSelect.value;
            const contextKey = contextSelect.value;
            
            let parts = [];
            
            if (styleKey === 'custom') {
                parts.push(customPromptInput.value.trim());
            } else {
                parts.push(`Instruction: Speak in ${lang}.`);
                if(styleMap[styleKey]) parts.push(`Character Style: ${styleMap[styleKey]}`);
                if(contextMap[contextKey]) parts.push(`Situational Tone: ${contextMap[contextKey]}`);
                if(modMap[modKey]) parts.push(`Voice Modification: ${modMap[modKey]}`);
            }

            let instruction = parts.join(" ");
            const finalText = `${instruction} Content: "${text}"`;
            debugPrompt.value = finalText;

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${key}`;
                const payload = {
                    contents: [{ parts: [{ text: finalText }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: { prebuiltVoiceConfig: { voiceName: voiceName } }
                        }
                    }
                };

                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || response.statusText);
                }

                const data = await response.json();
                const base64Audio = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;

                if (base64Audio) {
                    playPcmAudio(base64Audio);
                } else {
                    throw new Error("No audio data received");
                }
            } catch (error) {
                console.error(error);
                let msg = error.message;
                if(msg.includes("429")) msg = "Limit API Harian Habis. Coba besok.";
                if(msg.includes("key")) msg = "API Key Salah.";
                showToast(msg);
                setLoading(false);
            }
        }

        function playPcmAudio(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
            const wavBytes = pcmToWav(bytes, 24000);
            const blob = new Blob([wavBytes], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            audioPlayer.src = url;
            audioPlayer.classList.remove('hidden');
            audioPlayer.onplay = () => { visualizer.classList.add('animating'); visualizer.classList.remove('opacity-50'); };
            audioPlayer.onended = () => { visualizer.classList.remove('animating'); visualizer.classList.add('opacity-50'); setLoading(false); };
            audioPlayer.play();
        }

        function pcmToWav(pcmData, sampleRate) {
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);
            const byteRate = sampleRate * 2; 
            const blockAlign = 2;
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.length, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.length, true);
            const wavBuffer = new Uint8Array(44 + pcmData.length);
            wavBuffer.set(new Uint8Array(wavHeader), 0);
            wavBuffer.set(pcmData, 44);
            return wavBuffer;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) { view.setUint8(offset + i, string.charCodeAt(i)); }
        }

        function setLoading(isLoading) {
            if (isLoading) {
                speakBtn.disabled = true;
                speakBtn.innerHTML = '<div class="loader"></div> Generating...';
            } else {
                speakBtn.disabled = false;
                speakBtn.innerHTML = '<i class="fa-solid fa-play"></i> Generate & Play';
            }
        }
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 3000);
        }
        function clearText() { textInput.value = ''; }
        textInput.addEventListener('input', () => { document.getElementById('charCount').textContent = textInput.value.length + " chars"; });

        init();
    </script>
</body>
</html>


